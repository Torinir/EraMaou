;eraIM@Sから導入しました(eramaou)


;=================================================
;媚薬中毒関連の関数群
;=================================================
;-------------------------------------------------
;媚薬中毒の発病と回復
;-------------------------------------------------
@APHRODISIAC_ADDICT
;体内媚薬残留度を7日ごとに1減らす
IF (DAY + 1) % 7 == 0
	IF CFLAG:31 > 0
		CFLAG:31 -= 1
		SIF CFLAG:31 < 0
			CFLAG:31 = 0
	ENDIF
			
	;[媚薬中毒]の場合は禁断症状チェックも行う
	IF TALENT:46
		IF CFLAG:32
			CFLAG:32 = 0
		ELSE
			CALL PRECIPITATE_WITHDRAWAL
		ENDIF
	ENDIF
ENDIF

;[媚薬中毒]の消失判定
;体内媚薬残留度が0になれば[媚薬中毒]消失
IF CFLAG:31 == 0 && TALENT:46
	PRINTFORML %SAVESTR:TARGET%の様子が変わった......
	PRINTFORML 体内から媚薬の効果がすっかり抜けきり,%SAVESTR:TARGET%は依存症から脱した
	PRINTFORML %SAVESTR:TARGET%は[%TALENTNAME:46%]を失った
	WAIT
	TALENT:46 = 0
ENDIF
;[媚薬中毒]の取得判定
;[中毒しやすい]がなければ体内媚薬残留度が12以上,あれば9以上で[媚薬中毒]取得
IF ((TALENT:86 == 0 && CFLAG:31 >= 12) || (TALENT:72 && CFLAG:31 >= 9)) && TALENT:46 == 0
	PRINTFORML %SAVESTR:TARGET%の様子がおかしい......
	PRINTFORML 媚薬の過剰摂取によって,%SAVESTR:TARGET%は中毒になってしまった
	PRINTFORML %SAVESTR:TARGET%は[%TALENTNAME:46%]を得た
	WAIT
	TALENT:46 = 1
	;中毒になりたてということで,ボーナスとして体内媚薬残留度を一律15以上に(おめでとう!)
	SIF CFLAG:31 < 15
		CFLAG:31 = 15
ENDIF
;[狂気]の取得判定
;[中毒しやすい]がなければ体内媚薬残留度が40以上,あれば30以上で[狂気]取得
IF (CFLAG:31 >= 40 || (TALENT:72 && CFLAG:31 >= 30)) && TALENT:123 == 0
	PRINTFORML %SAVESTR:TARGET%の様子がおかしい......
	PRINTFORML %SAVESTR:TARGET%は媚薬の過剰摂取によって,気が触れてしまった
	PRINTFORML %SAVESTR:TARGET%は[%TALENTNAME:123%]を得た
	PRINTL 
	TALENT:123 = 1
ENDIF
;[廃人]の取得判定
;[中毒しやすい]がなければ体内媚薬残留度が100以上,あれば75以上で[崩壊]取得
IF (CFLAG:31 >= 100 || (TALENT:72 && CFLAG:31 >= 75)) && TALENT:9 == 0
	PRINTFORML %SAVESTR:TARGET%の様子がおかしい......
	PRINTFORML %SAVESTR:TARGET%は媚薬の過剰摂取によって,完全に廃人と化してしまった
	PRINTFORML %SAVESTR:TARGET%の精神は[%TALENTNAME:9%]してしまった
	PRINTL 
	TALENT:9 = 1
ENDIF
;-------------------------------------------------
;禁断症状イベント
;-------------------------------------------------
@PRECIPITATE_WITHDRAWAL
;U=[治療][献身的]持ちによる禁断症状緩和効果
;V=禁断症状の酷さ
;W=ステータス悪化の内容(＆ステータス悪化が生じたか否か)
U = 0
V = 0
W = 0
PRINTFORML %SAVESTR:TARGET%が体の不調を訴えているようだ
PRINTL どうやら,媚薬中毒の禁断症状が出てきているらしい......
WAIT

IF ITEM:26
	$INPUT_LOOP_01
	PRINTFORML %SAVESTR:TARGET%に媚薬を与えますか?
	PRINTL  [0] - はい
	PRINTL  [1] - いいえ
	INPUT
	IF RESULT == 0
		IF CFLAG:1 == 2
			PRINTFORML %SAVESTR:TARGET%に媚薬を与える代わりに魔王の軍門に下るかと誘惑すると
			PRINTFORMW 涎を垂らしながら喜んで勇者の使命をなげうった
			PRINTFORML %SAVESTR:TARGET%は陥落した
			CFLAG:1 = 0
			MONEY += 100 * CFLAG:9
			PRINTFORMW {100 * CFLAG:9}Gを入手!
			CFLAG:506 = 1
			CFLAG:507 = 0
			
			CALL PARTY_DEL, TARGET
		ENDIF
		PRINTFORML %SAVESTR:TARGET%は媚薬のエKiss入りアンプルを奪い取ると,
		PRINTFORML すぐさま貪るように一気に飲み干して,ほっと一息をついた
		WAIT
		CFLAG:31 += 1
		ITEM:26 -= 1
		RETURN 0
	ELSEIF RESULT != 1
		GOTO INPUT_LOOP_01
	ENDIF	
ENDIF

IF CFLAG:1 == 2
	PRINTFORML 数時間後,%SAVESTR:TARGET%の体のふるえがようやく止まった
	;体力が減る
	BASE:0 -= 300
	SIF BASE:0 < 1
		BASE:0 = 1
	RETURN 0
ENDIF


;[治療][献身的]持ちの人数をカウント
;ただし待機中のみカウント
REPEAT CHARANUM
	SIF TALENT:COUNT:117 && CFLAG:COUNT:1 == 0
		U += 1
	SIF TALENT:COUNT:63 && CFLAG:COUNT:1 == 0
		U += 1
REND

;体内媚薬残留度と[治療][献身的]持ちによる禁断症状緩和効果に応じてチェック回数決定
V = (CFLAG:31 / 10) + 1 - U
IF V < 1
	V = 1
ELSEIF V > 10
	V = 10
ENDIF

;チェック回数は最低1回～最高10回
REPEAT V
	;40%の確率でステータス悪化イベント発生
	;最高の10回チェックした場合は99.996%の確率で発生する計算
	IF RAND:100 < 40
		CALL SUFFER_FROM_WITHDRAWAL
		BREAK
	ENDIF
REND

IF W
	PRINTFORML 禁断症状の苦しみにのたうちまわっていた%SAVESTR:TARGET%だったが
	PRINTL 暴れ疲れたのか症状が収まったのか,数時間後,やっと大人しくなった
	PRINTL しかし,本人だけでなく看病していた側も疲れ果ててしまった......
	WAIT 
	PRINTFORML %SAVESTR:TARGET%は体力と気力が衰えた

	;とりあえず表示はせずにこっそり減らす方向で
	MAXBASE:0 -= 50
	SIF BASE:0 > MAXBASE:0
		BASE:0 = MAXBASE:0
	;最大体力は600まで下がる(それ以下にはならない)
	SIF MAXBASE:0 < 600
		MAXBASE:0 = 600
	
	MAXBASE:1 -= 50
	SIF BASE:1 > MAXBASE:1
		BASE:1 = MAXBASE:1
	;最大気力は100まで下がる(それ以下にはならない)
	SIF MAXBASE:1 < 100
		MAXBASE:1 = 100
	
	BASE:0 -= 500
	SIF BASE:0 < 1
		BASE:0 = 1

	;看病していた人もぐったりします
	;ただし待機中のみ看病します
	REPEAT CHARANUM
		;[治療][献身的]持ちは確実に看病している
		IF (TALENT:COUNT:117 || TALENT:COUNT:63) && CFLAG:COUNT:1 == 0
			BASE:COUNT:0 -= 200
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		;そうでない場合でも1/3の確率で看病に当たっている
		ELSEIF RAND:3 == 0 && CFLAG:COUNT:1 == 0
			BASE:COUNT:0 -= 200
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		ENDIF
	REND
ELSE
	PRINTFORML 数時間後,%SAVESTR:TARGET%の体のふるえがようやく止まった
	PRINTL 看病していた側も一苦労だったが
	PRINTL 今回はどうにか無事に乗り越えることができた
	WAIT
	;でも体力は減る
	BASE:0 -= 300
	SIF BASE:0 < 1
		BASE:0 = 1

	;看病していた人もぐったりします
	REPEAT CHARANUM
		;[治療][献身的]持ちは確実に看病している
		IF TALENT:COUNT:117 || TALENT:COUNT:63
			BASE:COUNT:0 -= 100
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		;そうでない場合でも1/3の確率で看病に当たっている
		ELSEIF RAND:3 == 0
			BASE:COUNT:0 -= 100
			SIF BASE:COUNT:0 < 1
				BASE:COUNT:0 = 1
		ENDIF
	REND
ENDIF
PRINTL 

@SUFFER_FROM_WITHDRAWAL
W = RAND:50 - V + (U * 2)

IF W < 5
	IF TALENT:9 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_WRECK
	ELSEIF TALENT:123 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
	ELSEIF RELATION:0 == 0 || RELATION:0 > 50
		CALL PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
	ELSEIF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 10
	IF TALENT:123 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
	ELSEIF RELATION:0 == 0 || RELATION:0 > 50
		CALL PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
	ELSEIF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 15
	IF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 20
	IF TALENT:34 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
	ELSEIF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 25
	IF TALENT:26 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
	ELSEIF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSEIF W < 30
	IF TALENT:22 == 0
		CALL PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
	ELSE
		CALL PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
	ENDIF
ELSE
	PRINTL 
ENDIF
PRINTL 

W = 1


@PRECIPITATE_WITHDRAWAL_FALL_INTO_DISFAVOR
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさですっかり%CALLNAME:MASTER%を嫌ってしまったようだ
;こっそり好感度をマイナス
CFLAG:2 -= 200

@PRECIPITATE_WITHDRAWAL_BE_A_ATHYMIA
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさですっかり感情を失ってしまったようだ
PRINTFORMW %SAVESTR:TARGET%は[感情乏しい]を得た
TALENT:22 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_DEPRESSION
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさですっかり悲観的になってしまったようだ
PRINTFORMW %SAVESTR:TARGET%は[悲観的]を得た
TALENT:26 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_RESISTER
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさですっかり気難しくなってしまったようだ
PRINTFORMW %SAVESTR:TARGET%は[抵抗]を得た
TALENT:34 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_MISANTHROPIST
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさですっかり%CALLNAME:MASTER%を嫌ってしまったようだ
IF RELATION:0 == 0
	RELATION:0 = 50
ELSE
	RELATION:0 -= 50
	SIF RELATION:0 < 30
		RELATION:0 = 30
ENDIF
;こっそり好感度もマイナス
CFLAG:2 -= 200

@PRECIPITATE_WITHDRAWAL_BE_A_CRAZY
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさで気が触れてしまったようだ
PRINTFORMW %SAVESTR:TARGET%は[狂気]を得た
TALENT:123 = 1

@PRECIPITATE_WITHDRAWAL_BE_A_WRECK
PRINTFORMW %SAVESTR:TARGET%の様子が明らかにおかしい......
PRINTFORMW %SAVESTR:TARGET%は禁断症状の苦しさで完全に廃人と化してしまったようだ
PRINTFORMW %SAVESTR:TARGET%の精神は[崩壊]してしまった......
TALENT:19 = 1

