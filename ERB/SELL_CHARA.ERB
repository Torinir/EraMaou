
;eraIM@Sから導入しました(eramaou)

;-------------------------------------------------
;売却と助手化のチェック
;-------------------------------------------------
@CHECK_SELLASSIABLE

SIF TARGET < 0 || TARGET >= CHARANUM
	RETURN 0

;従順+欲望が6LV以上であるか
SIF ABL:10+ABL:11 < 6
	RETURN 0
;C感覚-V感覚-A感覚-B感覚のいずれかが最低3LVであり
SIF ABL:0 < 3 && ABL:1 < 3 && ABL:2 < 3 && ABL:3 < 3
	RETURN 0
;[反抗的]か[気丈]を持っているなら従順が4LV以上になっており
SIF ABL:10 < 4 && (TALENT:11 || TALENT:12)
	RETURN 0
;[自制心][抑圧][抵抗]を持っているなら欲望が4LV以上になっており
SIF ABL:11 < 4 && (TALENT:20 || TALENT:32 || TALENT:34)
	RETURN 0
;"〈技巧〉3LV以上で〈奉仕精神〉3LV以上"か"〈露出癖〉3LV以上で〈自慰中毒〉2LV以上"か"C-V-A-B感覚の合計が13LV以上"か"従順か欲望がLV5"に達しているか
IF (ABL:12 >= 3 && ABL:16 >= 3) || (ABL:17 >= 3 && ABL:31 >= 2) || ABL:21 >= 3 || (ABL:0+ABL:1+ABL:2+ABL:3 >= 13) || ABL:10 >= 5 || ABL:11 >= 5
	IF CFLAG:0 <= 0
		PRINTFORMW %SAVESTR:TARGET%が売却可能になりました
		CFLAG:0 = 1
	ENDIF
ELSE
	RETURN 0
ENDIF

;"〈従順〉〈欲望〉〈技巧〉〈Ｃ感覚〉〈レズっ気〉がすべて3LV以上"か"〈従順〉が5LV以上かつ〈欲望〉が4LV以上"か
IF (ABL:10 >= 3 && ABL:11 >= 3 && ABL:12 >= 3 && ABL:0 >= 3 && ABL:22 >= 3) || (ABL:10 >= 5 && ABL:11 >= 4)
	IF CFLAG:0 <= 1
		PRINTFORMW %SAVESTR:TARGET%が助手可能になりました
		CFLAG:0 = 2
	ENDIF
ENDIF
;
;-------------------------------------------------
;奴隷売却の処理
;-------------------------------------------------
@CHARA_SALE
#DIM PRICE_N
#DIMS PRICE_S
DRAWLINE
PRINTV DAY+1
PRINT 日目
IF TIME == 0
	PRINTL  午前
ELSE
	PRINTL  午後
ENDIF

PRINTFORML 所持金:${MONEY}ポイント
DRAWLINE

$INPUT_LOOP

PRINTL 誰を売りますか?
PRINTL ..............................................................................
REPEAT CHARANUM
	IF COUNT == 0
		CONTINUE
	;売れないキャラは排除
	ELSEIF CFLAG:COUNT:0 < 1
		CONTINUE
	;臨死中のキャラは排除
	ELSEIF  BASE:COUNT:0 < 1
		CONTINUE
	;魔王の影は排除
	ELSEIF TALENT:COUNT:292
		CONTINUE
	ELSEIF CFLAG:COUNT:1 == 0
		PRINTFORM [{COUNT}] %SAVESTR:COUNT, 16, LEFT% 
		TARGET = COUNT
		S = 0
		CALL ESTIMATE_CHARA
		PRICE_N = S
		PRICE_S = 
		WHILE PRICE_N > 0
			IF PRICE_N < 1000
				PRICE_S = {PRICE_N % 1000}%PRICE_S%
			ELSE
				PRICE_S = ,{PRICE_N % 1000 / 100}{PRICE_N % 100 / 10}{PRICE_N % 10}%PRICE_S%
			ENDIF
			PRICE_N /= 1000
		WEND
		IF S > 0
			PRINTFORM [評価額:%PRICE_S, 13%ポイント]
		ELSE
			PRINTFORM [売却不可]
		ENDIF
		IF ISASSI:COUNT == 1
			PRINT (元助手)
		ELSEIF CFLAG:COUNT:1 == 2
			PRINT (助手可)
		ENDIF
		SIF CFLAG:COUNT:700
			PRINT [☆]
		PRINTL  
	ENDIF
REND
PRINTL ..............................................................................
PRINTFORML [999] - 戻る

INPUT

IF RESULT == 999
	TARGET = FLAG:1
	RETURN 999
ELSEIF RESULT <= 0 || RESULT >= CHARANUM
	GOTO INPUT_LOOP
ELSEIF CFLAG:RESULT:0 < 1
	GOTO INPUT_LOOP
;臨死中のキャラは排除
ELSEIF BASE:RESULT:0 < 1
	GOTO INPUT_LOOP
;営業中のキャラは排除
ELSEIF  CFLAG:RESULT:12 && TIME == 1
	PRINTL 今日の営業が済むまでは売れません
	WAIT
	GOTO INPUT_LOOP
ELSEIF CFLAG:RESULT:700
	PRINTFORMW %SAVESTR:RESULT%はお気に入り登録されているため売却できません.
	GOTO INPUT_LOOP
;魔王の影は排除
ELSEIF TALENT:RESULT:292
	PRINTFORMW %SAVESTR:RESULT%は影でありあなたを離れると消えるため売却できません.
	GOTO INPUT_LOOP
ENDIF

;現在の調教対象の情報を取得
SIF TARGET > 0
	T = NO:TARGET

TARGET = RESULT

;売却処理
S = 0
CALL SALE_CHARA

;長いお別れ
SIF S > 0
	CALL LONG_GOOD_BYE

;売却した場合はキャラを削除
IF S > 0
	T = -1
	CALL KILL_TARGET
ENDIF

;対象を戻す
TARGET = -1
REPEAT CHARANUM
	SIF NO:COUNT == T
		TARGET = COUNT
REND



RESTART
;
;-------------------------------------------------
;現在の調教対象の削除
;-------------------------------------------------
@KILL_TARGET
X = NO:TARGET + 199
FLAG:X = 1

CALL PARTY_CHAR_DEL, TARGET

;キャラ削除
DELCHARA TARGET

;前回の助手-調教対象だった場合はフラグを空に
SIF FLAG:1 == TARGET
	FLAG:1 = -1
SIF FLAG:2 == TARGET
	FLAG:2 = -1

;前回の助手-調教対象より前だった場合はフラグを減算
SIF FLAG:1 > TARGET
	FLAG:1 -= 1
SIF FLAG:2 > TARGET
	FLAG:2 -= 1

;調教対象を空に
TARGET = FLAG:1

;助手を空に
ASSI = FLAG:2

REPEAT CHARANUM
	SIF COUNT >= 1
		CALL NAMING, COUNT
REND
;
;-------------------------------------------------
;長いお別れ
;-------------------------------------------------
@LONG_GOOD_BYE
A = NO:TARGET

REPEAT CHARANUM
	SIF COUNT == 0
		CONTINUE
	;キャラのストレス値
	U = 0
	SIF A == (CFLAG:COUNT:21 % 100) && (CFLAG:COUNT:21 / 100) < 2
		U += 40
	SIF A == (CFLAG:COUNT:21 % 100)
		U += 80
	SIF A == (CFLAG:COUNT:22 % 100) && (CFLAG:COUNT:22 / 100) < 2
		U += 40
	SIF A == (CFLAG:COUNT:22 % 100)
		U += 80
	SIF A == (CFLAG:COUNT:23 % 100) && (CFLAG:COUNT:23 / 100) < 2
		U += 40
	SIF A == (CFLAG:COUNT:23 % 100)
		U += 80
	SIF A == (CFLAG:COUNT:24 % 100) && (CFLAG:COUNT:24 / 100) < 2
		U += 40
	SIF A == (CFLAG:COUNT:24 % 100)
		U += 80
	SIF A == (CFLAG:COUNT:25 % 100) && (CFLAG:COUNT:25 / 100) < 2
		U += 40
	SIF A == (CFLAG:COUNT:25 % 100)
		U += 80
	SIF RELATION:COUNT:A > 100
		U += RELATION:COUNT:A - 100
	IF U > 50
		DRAWLINE
		PRINTL 
		PRINTFORML その日,%NAME:COUNT%は,売られていく%SAVESTR:TARGET%が乗っている輸送車が,
		SIF TALENT:COUNT:45 == 0
			PRINT 涙でぼやけた
		PRINTFORML 視界の外に出て見えなくなるまで,
		PRINTFORML そして見えなくなった後も,ずっと見送っていた.
		WAIT
		;愛
		SIF TALENT:COUNT:85
			U -= 120
		;淫乱
		SIF TALENT:COUNT:76
			U -= 60
		;気丈
		SIF TALENT:COUNT:12
			U -= 20
		;感情乏しい
		SIF TALENT:COUNT:22
			U -= 20
		;心弱い
		SIF TALENT:COUNT:134
			U += 20
		;従順
		U -= ABL:COUNT:10 * 10
		;反発刻印
		U += MARK:COUNT:3 * 30

		;ストレス値の累積が100を超えた場合
		IF U >= 100 && TALENT:COUNT:9 == 0
		DRAWLINE
			PRINTFORML %CALLNAME:COUNT%は呆然とした面持ちをしている
			PRINTFORML %CALLNAME:COUNT%の中で何かが壊れてしまったようだ......
			PRINTFORML %CALLNAME:COUNT%の精神は[%TALENTNAME:9%]してしまった
			WAIT
			IF TALENT:COUNT:85
				PRINTFORML %CALLNAME:COUNT%は[%TALENTNAME:85%]を失った
				TALENT:COUNT:85 = 0
			ENDIF
			IF TALENT:COUNT:76
				PRINTFORML %CALLNAME:COUNT%は[%TALENTNAME:76%]を失った
				TALENT:COUNT:76 = 0
			ENDIF
			TALENT:COUNT:9 = 1
			WAIT
		ENDIF
	ENDIF
REND
;-------------------------------------------------
;奴隷売却
;-------------------------------------------------
@SALE_CHARA

;売却額
S = 0
CALL ESTIMATE_CHARA

;評価表示
SIF A:10 > 0
	PRINTFORML %ABLNAME:10, 8, LEFT%{ABL:10, 2}LV +{A:10, 5}
SIF A:11 > 0
	PRINTFORML %ABLNAME:11, 8, LEFT%{ABL:11, 2}LV +{A:11, 5}
SIF A:12 > 0
	PRINTFORML %ABLNAME:12, 8, LEFT%{ABL:12, 2}LV +{A:12, 5}
SIF A:13 > 0
	PRINTFORML %ABLNAME:13, 8, LEFT%{ABL:13, 2}LV +{A:13, 5}
SIF A:14 > 0
	PRINTFORML %ABLNAME:14, 8, LEFT%{ABL:14, 2}LV +{A:14, 5}
SIF A:15 > 0
	PRINTFORML %ABLNAME:15, 8, LEFT%{ABL:15, 2}LV +{A:15, 5}
SIF A:30 > 0
	PRINTFORML %ABLNAME:30, 8, LEFT%{ABL:30, 2}LV +{A:30, 5}
SIF A:31 > 0
	PRINTFORML %ABLNAME:31, 8, LEFT%{ABL:31, 2}LV +{A:31, 5}
SIF A:32 > 0
	PRINTFORML %ABLNAME:32, 8, LEFT%{ABL:32, 2}LV +{A:32, 5}
SIF A:33 > 0
	PRINTFORML %ABLNAME:33, 8, LEFT%{ABL:33, 2}LV +{A:33, 5}
SIF A:39 > 0
	PRINTFORML %ABLNAME:39, 8, LEFT%{ABL:39, 2}LV +{A:39, 5}
SIF A:37 > 0
	PRINTFORML %ABLNAME:37, 8, LEFT%{ABL:37, 2}LV －{A:37, 5}
SIF B:0 > 0
	PRINTFORML Ｃ感覚封鎖　 －{B:0, 5}
SIF B:1 > 0
	PRINTFORML V感覚封鎖　 －{B:1, 5}
SIF B:2 > 0
	PRINTFORML A感覚封鎖　 －{B:2, 5}
SIF B:3 > 0
	PRINTFORML Ｂ感覚封鎖　 －{B:3, 5}

SIF A:0 != 100
	PRINTFORML %ABLNAME:0, 8, LEFT%{ABL:0, 2}LV × {A:0/100}.{A:0%100/10}{A:0%10}
SIF A:1 != 100
	PRINTFORML %ABLNAME:1, 8, LEFT%{ABL:1, 2}LV × {A:1/100}.{A:1%100/10}{A:1%10}
SIF A:2 != 100
	PRINTFORML %ABLNAME:2, 8, LEFT%{ABL:2, 2}LV × {A:2/100}.{A:2%100/10}{A:2%10}
SIF A:3 != 100
	PRINTFORML %ABLNAME:3, 8, LEFT%{ABL:3, 2}LV × {A:3/100}.{A:3%100/10}{A:3%10}
SIF A:16 != 100
	PRINTFORML %ABLNAME:16, 8, LEFT%{ABL:16, 2}LV × {A:16/100}.{A:16%100/10}{A:16%10}
SIF A:17 != 100
	PRINTFORML %ABLNAME:17, 8, LEFT%{ABL:17, 2}LV × {A:17/100}.{A:17%100/10}{A:17%10}
SIF A:20 != 100
	PRINTFORML %ABLNAME:20, 8, LEFT%{ABL:20, 2}LV × {A:20/100}.{A:20%100/10}{A:20%10}
SIF A:21 != 100
	PRINTFORML %ABLNAME:21, 8, LEFT%{ABL:21, 2}LV × {A:21/100}.{A:21%100/10}{A:21%10}
SIF A:22 != 100
	PRINTFORML %ABLNAME:22, 8, LEFT%{ABL:22, 2}LV × {A:22/100}.{A:22%100/10}{A:22%10}
SIF A:23 != 100
	PRINTFORML %ABLNAME:23, 8, LEFT%{ABL:23, 2}LV × {A:23/100}.{A:23%100/10}{A:23%10}

SIF E:74 != 100
	PRINTFORML %EXPNAME:74, 8, LEFT%{EXP:74, 4} × {E:74/100}.{E:74%100/10}{E:74%10}
SIF E:60 != 100
	PRINTFORML %EXPNAME:60, 8, LEFT%{EXP:60, 4} × {E:60/100}.{E:60%100/10}{E:60%10}

;素質による倍率表示
REPEAT 300
	SIF T:COUNT != 100
		PRINTFORML %TALENTNAME:COUNT, 12, LEFT% × {T:COUNT/100}.{T:COUNT%100/10}{T:COUNT%10}
REND

SIF T:310 != 100
	PRINTFORML 元親衛隊　　 × {T:310/100}.{T:310%100/10}{T:310%10}

SIF T:311 != 100
	PRINTFORML 元勇者　　　 × {T:311/100}.{T:311%100/10}{T:311%10}

SIF O:0 != 100
	PRINTFORML 元助手　　　 × {O:0/100}.{O:0%100/10}{O:0%10}

PRINT 種族:
IF TALENT:314 == 0
	PRINTFORML 人間
ELSEIF TALENT:314 == 1
	PRINTFORML エルフ
ELSEIF TALENT:314 == 2
	PRINTFORML 人狼
ELSEIF TALENT:314 == 3
	PRINTFORML 吸血鬼
ELSEIF TALENT:314 == 4
	PRINTFORML デュラハン
ELSEIF TALENT:314 == 5
	PRINTFORML ドラゴン
ELSEIF TALENT:314 == 6
	PRINTFORML 天使
ELSEIF TALENT:314 == 7
	PRINTFORML ダ-クエルフ
ELSEIF TALENT:314 == 8
	PRINTFORML 堕天使
ELSEIF TALENT:314 == 9
	PRINTFORML 魔族
ELSEIF TALENT:314 == 10
	PRINTFORML ホビット
ELSEIF TALENT:314 == 11
	PRINTFORML ドワ-フ
ENDIF

PRINTFORML 　　　　　　 × {T:314/100}.{T:314%100/10}{T:314%10}

IF O:1 != 100
	PRINTFORM 値上げ交渉 ×{O:1/100}.
	SIF O:1 > 100 && O:1 < 110
		PRINT 0
	PRINTFORML {O:1%100}
ENDIF

;売却額表示
PRINTFORML %SAVESTR:TARGET%は{S}ポイントで売れそうです.
PRINTFORML %SAVESTR:TARGET%を売却しますか?
PRINTL  [0] - はい
PRINTL  [1] - いいえ

$INPUT_LOOP
INPUT

IF RESULT == 0
	;売却時口上
	TFLAG:13 = 6
	CALL SELF_KOJO

	PRINTFORMW %SAVESTR:TARGET%を{S}ポイントで売却しました.
	MONEY += S
	RETURN 1
ELSEIF RESULT == 1
	S = -1
	RETURN 0
ELSE
	GOTO INPUT_LOOP
ENDIF
;
;
;